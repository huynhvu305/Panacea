<!-- üõí GI·ªé H√ÄNG N·ªîI -->
<div class="cart-floating" *ngIf="shouldShowCart" (click)="toggleCart()">
    <i class="bi bi-cart-fill"></i>
    <span class="cart-count" *ngIf="cartCount > 0">{{ cartCount }}</span>
</div>

<!-- POPUP GI·ªé H√ÄNG -->
<div class="cart-popup" *ngIf="isCartOpen && shouldShowCart" (click)="toggleCart()">
    <div class="cart-popup-content" (click)="$event.stopPropagation()">
        <h5 class="cart-title"><i class="bi bi-cart-check me-2"></i>Gi·ªè h√†ng</h5>

        <div *ngIf="cart.length > 0; else emptyCart">
            <!-- üü© UPDATED: Hi·ªÉn th·ªã items ƒë√£ ƒë∆∞·ª£c g·ªôp (theo ph√≤ng v√† gi·ªù li√™n ti·∫øp) -->
            <div class="cart-item-group mb-3" *ngFor="let group of getGroupedCartItems(); let groupIndex = index">
                <div class="cart-item">
                    <img [src]="group.photo" [alt]="'H√¨nh ·∫£nh ph√≤ng ' + group.roomName + ' - Panacea'" 
                      [title]="'H√¨nh ·∫£nh ph√≤ng ' + group.roomName + ' - ' + group.date + ' ' + group.time + ' - Panacea'"
                      class="cart-img" />
                    <div class="cart-info">
                        <h6>{{ group.roomName }}</h6>
                        <p>{{ group.date }} ¬∑ {{ group.time }}</p>
                        <div *ngIf="group.expertServices?.length">
                            <small class="text-primary">D·ªãch v·ª• chuy√™n gia:</small>
                            <ul>
                                <li *ngFor="let ex of group.expertServices">{{ ex.name }} (+{{ ex.price | currency:'VND' }})
                                </li>
                            </ul>
                        </div>
                        <div *ngIf="group.extraServices?.length">
                            <small class="text-primary">D·ªãch v·ª• th√™m:</small>
                            <ul>
                                <li *ngFor="let s of group.extraServices">{{ s.name }} x{{ s.quantity || 1 }} (+{{ (s.price * (s.quantity || 1)) | currency:'VND' }})</li>
                            </ul>
                        </div>
                        <span class="price">{{ group.totalPrice | currency:'VND' }}</span>
                    </div>

                    <button class="btn-remove" (click)="removeGroupFromCart(group)">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <!-- üü© ADDED: N√∫t thanh to√°n cho nh√≥m n√†y -->
                <div class="cart-item-payment mt-2">
                    <button class="btn btn-primary w-100 fw-semibold" (click)="goToPaymentForGroup(group)">
                        Thanh to√°n
                    </button>
                </div>
                
                <!-- D√≤ng ph√¢n c√°ch gi·ªØa c√°c nh√≥m -->
                <hr *ngIf="groupIndex < getGroupedCartItems().length - 1" class="my-3">
            </div>
        </div>

        <ng-template #emptyCart>
            <p class="text-center text-muted">Ch∆∞a c√≥ ph√≤ng n√†o trong gi·ªè.</p>
        </ng-template>
    </div>
</div>

