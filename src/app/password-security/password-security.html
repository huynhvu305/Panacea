<div class="container-fluid">
    <div class="password-security">
        <!-- ĐỔI MẬT KHẨU -->
        <section class="security-section">
            <h2>Đổi mật khẩu</h2>
            <p class="section-desc">
                Vì lý do bảo mật, bạn sẽ cần đăng nhập lại bằng mật khẩu mới trên tất cả các thiết bị.
            </p>

            <!-- Mật khẩu hiện tại -->
            <div class="form-group mb-3 position-relative input-with-icon">
                <label>Mật khẩu hiện tại</label>
                <input [type]="showCurrent ? 'text' : 'password'" class="form-control"
                    [(ngModel)]="passwordForm.currentPassword" placeholder="Nhập mật khẩu hiện tại" />
            </div>

            <!-- Mật khẩu mới -->
            <div class="form-group position-relative input-with-icon">

                <!-- HÀNG TIÊU ĐỀ: label bên trái + "Mẹo..." bên phải (cùng một hàng) -->
                <div class="label-row d-flex justify-content-between align-items-center">
                    <label class="mt-2 mb-1">Mật khẩu mới</label>

                    <div class="tips-inline"><!-- positioned by CSS, no absolute hack -->
                        <button type="button" class="btn btn-link p-0 tips-link" (click)="toggleTips()">
                            <i class="bi bi-lightbulb me-1"></i> Mẹo để tạo mật khẩu mạnh và dễ nhớ
                        </button>

                        <!-- popover nổi PHÍA TRÊN, canh phải dòng "Mẹo..." -->
                        <div class="tips-popover tips-top-right" *ngIf="showTips">
                            <button type="button" class="btn-close btn-close-white float-end" aria-label="Đóng"
                                (click)="showTips=false"></button>
                            <ol class="mb-0">
                                <li>Cá nhân hóa bằng một câu trích dẫn/đoạn phim/cụm từ bạn thích.</li>
                                <li>Thay một vài chữ cái bằng số/ký tự đặc biệt (vd: <code>W@nd3rlust2024</code>).</li>
                                <li>Hình dung cụm đó trong đầu — giúp bạn nhớ lâu hơn.</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="input-row">
                    <input [type]="showNew ? 'text' : 'password'" class="form-control pe-5"
                        [(ngModel)]="passwordForm.newPassword" (input)="onTypingNew()" placeholder="Tối thiểu 8 ký tự"
                        [ngClass]="{
      'is-valid': hasMinLength && hasLetter && hasNumber,
      'is-invalid': passwordForm.newPassword && !(hasMinLength && hasLetter && hasNumber)
    }" />
                    <button type="button" class="btn-eye" (click)="toggleVisibility('new')"
                        aria-label="Hiện/ẩn mật khẩu mới">
                        <i class="bi" [ngClass]="showNew ? 'bi-eye-slash' : 'bi-eye'"></i>
                    </button>
                </div>

                <!-- hướng dẫn khi CHƯA gõ gì -->
                <small class="form-text" *ngIf="!passwordForm.newPassword">
                    Sử dụng kết hợp chữ cái, số và ký hiệu. Đảm bảo bạn chưa từng sử dụng mật khẩu này trước đây.
                </small>

                <!-- checklist khi ĐÃ gõ -->
                <ul class="pw-checklist mt-2" *ngIf="passwordForm.newPassword">
                    <li [class.ok]="hasMinLength">
                        <i class="bi" [ngClass]="hasMinLength ? 'bi-check-circle-fill' : 'bi-x-circle'"></i>
                        Tối thiểu <b>8 ký tự</b>
                    </li>
                    <li [class.ok]="hasLetter">
                        <i class="bi" [ngClass]="hasLetter ? 'bi-check-circle-fill' : 'bi-x-circle'"></i>
                        Có ít nhất <b>1 chữ cái</b>
                    </li>
                    <li [class.ok]="hasNumber">
                        <i class="bi" [ngClass]="hasNumber ? 'bi-check-circle-fill' : 'bi-x-circle'"></i>
                        Có ít nhất <b>1 chữ số</b>
                    </li>
                </ul>
            </div>

            <!-- Xác nhận mật khẩu mới -->
            <div class="form-group position-relative input-with-icon">
                <label class="mt-2">Xác nhận mật khẩu mới</label>
                <div class="input-row">
                    <input [type]="showConfirm ? 'text' : 'password'" class="form-control pe-5"
                        [(ngModel)]="passwordForm.confirmPassword" (input)="onTypingConfirm()"
                        placeholder="Nhập lại mật khẩu mới" [ngClass]="{
      'is-valid': passwordForm.confirmPassword && matchConfirm,
      'is-invalid': passwordForm.confirmPassword && !matchConfirm
    }" />
                    <button type="button" class="btn-eye" (click)="toggleVisibility('confirm')"
                        aria-label="Hiện/ẩn xác nhận mật khẩu">
                        <i class="bi" [ngClass]="showConfirm ? 'bi-eye-slash' : 'bi-eye'"></i>
                    </button>
                </div>

                <!-- cảnh báo không khớp (inline) -->
                <div class="invalid-feedback d-block" *ngIf="passwordForm.confirmPassword && !matchConfirm">
                    Mật khẩu xác nhận <b>không trùng khớp</b>. Vui lòng nhập lại.
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-outline-secondary">Để sau</button>
                <button class="btn btn-primary" (click)="changePassword()" [disabled]="!canSubmit()">Đổi mật
                    khẩu</button>
            </div>
        </section>

        <!-- XÁC THỰC 2 LỚP -->
        <section class="security-section">
            <h2>Bảo mật & Xác thực</h2>
            <div class="security-option">
                <div>
                    <label class="fw-semibold text-blue">Bật xác thực 2 lớp</label>
                    <p class="form-text">Gửi mã xác thực mỗi khi đăng nhập từ thiết bị mới</p>
                </div>
                <label class="switch">
                    <input type="checkbox" [checked]="twoFactorEnabled" (change)="toggleTwoFactor()" />
                    <span class="slider round"></span>
                </label>
            </div>
        </section>

        <!-- KHU VỰC NGUY HIỂM -->
        <section class="security-section danger-zone">
            <h2 class="text-danger">Xóa tài khoản</h2>
            <p class="text-muted">
                Khi xóa tài khoản, bạn sẽ không thể khôi phục lại tài khoản và dữ liệu.
            </p>
            <button class="btn btn-danger" (click)="deleteAccount()">Xóa tài khoản</button>
        </section>
    </div>
</div>