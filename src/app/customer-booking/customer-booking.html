<div class="acc-point-wrapper container-fluid p-4">
    <div class="row justify-content-center align-items-start g-4">
        <!-- SIDEBAR -->
        <div class="col-lg-3 col-md-4 mb-4">
            <app-user-toolbar></app-user-toolbar>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-lg-9 col-md-8">
            <div class="acc-point-card shadow-lg p-4">
                <h2 class="text-center mb-4 title">H·ªßy l·ªãch/ ƒê·ªïi l·ªãch</h2>

                <!-- Tabs -->
                <div class="order-tabs mb-3">
                    <button class="tab-btn" [class.active]="activeTab==='reschedule'" (click)="setTab('reschedule')">
                        ƒê·ªïi l·ªãch
                    </button>
                    <button class="tab-btn" [class.active]="activeTab==='cancel'" (click)="setTab('cancel')">
                        H·ªßy l·ªãch
                    </button>
                </div>

                <!-- Tab Content: ƒê·ªïi l·ªãch -->
                <div *ngIf="activeTab === 'reschedule'">
                    <div class="order-list" *ngIf="reschedulableBookings.length > 0; else emptyReschedule">
                        <div class="order-card" *ngFor="let booking of reschedulableBookings"
                            (click)="openDetailModal(booking)">
                            <div class="order-head">
                                <div class="order-id">
                                    M√£ ƒë∆°n: <strong>{{ booking.id }}</strong>
                                </div>
                                <span class="badge status-badge status-confirmed">
                                    {{ booking.status === 'confirmed' ? 'ƒê√£ x√°c nh·∫≠n' : 'Ch·ªù x√°c nh·∫≠n' }}
                                </span>
                            </div>

                            <div class="order-body">
                                <div class="order-room">
                                    <div class="room-title">{{ booking.room?.room_name || 'N/A' }}</div>
                                    <div class="room-sub">{{ booking.range }}</div>
                                </div>
                                <div class="order-time">
                                    <div class="label">Th·ªùi gian hi·ªán t·∫°i</div>
                                    <div class="value">{{ booking.startTime }} - {{ booking.endTime }}</div>
                                </div>
                                <div class="order-price">
                                    <div class="label">T·ªïng ti·ªÅn</div>
                                    <div class="value">{{ (booking.totalPrice || 0).toLocaleString('vi-VN') }}‚Ç´</div>
                                </div>
                                <div class="order-action">
                                    <button type="button" class="btn btn-primary btn-sm"
                                        (click)="$event.stopPropagation(); openRescheduleModal(booking)">
                                        <i class="bi bi-calendar-event me-1"></i>ƒê·ªïi l·ªãch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ng-template #emptyReschedule>
                        <div class="order-empty">
                            <div class="empty-icon">üìÖ</div>
                            <div class="empty-text">Kh√¥ng c√≥ l·ªãch n√†o c√≥ th·ªÉ ƒë·ªïi</div>
                        </div>
                    </ng-template>
                </div>

                <!-- Tab Content: H·ªßy l·ªãch -->
                <div *ngIf="activeTab === 'cancel'">
                    <div class="order-list" *ngIf="cancelableBookings.length > 0; else emptyCancel">
                        <div class="order-card" *ngFor="let booking of cancelableBookings"
                            (click)="openDetailModal(booking)">
                            <div class="order-head">
                                <div class="order-id">
                                    M√£ ƒë∆°n: <strong>{{ booking.id }}</strong>
                                </div>
                                <span class="badge status-badge status-confirmed">
                                    {{ booking.status === 'confirmed' ? 'ƒê√£ x√°c nh·∫≠n' : 'Ch·ªù x√°c nh·∫≠n' }}
                                </span>
                            </div>

                            <div class="order-body">
                                <div class="order-room">
                                    <div class="room-title">{{ booking.room?.room_name || 'N/A' }}</div>
                                    <div class="room-sub">{{ booking.range }}</div>
                                </div>
                                <div class="order-time">
                                    <div class="label">Th·ªùi gian</div>
                                    <div class="value">{{ booking.startTime }} - {{ booking.endTime }}</div>
                                </div>
                                <div class="order-price">
                                    <div class="label">T·ªïng ti·ªÅn</div>
                                    <div class="value">{{ (booking.totalPrice || 0).toLocaleString('vi-VN') }}‚Ç´</div>
                                </div>
                                <div class="order-action">
                                    <button type="button" class="btn btn-danger btn-sm"
                                        (click)="$event.stopPropagation(); cancelBooking(booking)">
                                        <i class="bi bi-x-circle me-1"></i>H·ªßy l·ªãch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <ng-template #emptyCancel>
                        <div class="order-empty">
                            <div class="empty-icon">üìÖ</div>
                            <div class="empty-text">Kh√¥ng c√≥ l·ªãch n√†o c√≥ th·ªÉ h·ªßy</div>
                        </div>
                    </ng-template>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Xem chi ti·∫øt -->
<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()"></div>
<div class="modal-container" *ngIf="showDetailModal" (click)="$event.stopPropagation()">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Chi ti·∫øt ƒë·∫∑t ph√≤ng</h4>
            <button class="btn-close" (click)="closeDetailModal()">√ó</button>
        </div>

        <div class="modal-body" *ngIf="selectedBookingForDetail">
            <!-- üîπ TH√îNG TIN KH√ÅCH H√ÄNG -->
            <div class="modal-section">
                <h5>Th√¥ng tin kh√°ch h√†ng</h5>
                <div class="info-row"><span>T√™n:</span>
                    <p>{{ selectedBookingForDetail.customerName }}</p>
                </div>
                <div class="info-row"><span>Email:</span>
                    <p>{{ selectedBookingForDetail.customerEmail }}</p>
                </div>
                <div class="info-row"><span>S·ªë ƒëi·ªán tho·∫°i:</span>
                    <p>{{ selectedBookingForDetail.customerPhone }}</p>
                </div>
            </div>

            <!-- üîπ TH√îNG TIN ƒê·∫∂T PH√íNG -->
            <div class="modal-section">
                <h5>Th√¥ng tin ƒë·∫∑t ph√≤ng</h5>
                <div class="info-row"><span>M√£ ƒë∆°n:</span>
                    <p>{{ selectedBookingForDetail.id }}</p>
                </div>
                <div class="info-row"><span>Ph√≤ng:</span>
                    <p>{{ getRoomName(selectedBookingForDetail) }}</p>
                </div>
                <div class="info-row"><span>Ph·∫°m vi:</span>
                    <p>{{ selectedBookingForDetail.range }}</p>
                </div>
                <div class="info-row"><span>Gi·ªù ƒë·∫∑t:</span>
                    <p>{{ selectedBookingForDetail.startTime }} ‚Üí {{ selectedBookingForDetail.endTime }}</p>
                </div>
                <div class="info-row"><span>Gi·ªù s·ª≠ d·ª•ng th·ª±c t·∫ø:</span>
                    <p>
                        {{ selectedBookingForDetail.checkInTime || '‚Äî' }} ‚Üí {{ selectedBookingForDetail.checkOutTime ||
                        '‚Äî' }}
                    </p>
                </div>
                <div class="info-row"><span>Tr·∫°ng th√°i:</span>
                    <p><span class="badge status-badge {{ getStatusClass(selectedBookingForDetail.status) }}">
                            {{ getStatusLabel(selectedBookingForDetail.status) }}</span></p>
                </div>
            </div>

            <!-- üîπ D·ªäCH V·ª§ ƒêI K√àM -->
            <div class="modal-section">
                <h5>D·ªãch v·ª• ƒëi k√®m</h5>
                <ul
                    *ngIf="selectedBookingForDetail.services && selectedBookingForDetail.services.length > 0; else noService">
                    <li *ngFor="let s of selectedBookingForDetail.services">
                        {{ s.name }}
                        <span *ngIf="s.quantity && s.quantity > 1">√ó {{ s.quantity }}</span>
                        - {{ formatCurrency(getServiceTotalPrice(s)) }}
                    </li>
                </ul>
                <ng-template #noService>
                    <p class="text-muted">Kh√¥ng c√≥ d·ªãch v·ª• th√™m</p>
                </ng-template>
            </div>

            <!-- üîπ VOUCHER & THANH TO√ÅN -->
            <div class="modal-section">
                <h5>Voucher & Thanh to√°n</h5>
                <div class="info-row"><span>Gi√° ph√≤ng:</span>
                    <p>{{ formatCurrency(selectedBookingForDetail.basePrice || 0) }}</p>
                </div>
                <div class="info-row"><span>T·ªïng d·ªãch v·ª•:</span>
                    <p>{{ formatCurrency(getTotalServicesPrice(selectedBookingForDetail)) }}</p>
                </div>
                <div class="info-row"><span>T·∫°m t√≠nh:</span>
                    <p>{{ formatCurrency(getSubtotal(selectedBookingForDetail)) }}</p>
                </div>
                <div class="info-row"><span>Voucher:</span>
                    <p>{{ selectedBookingForDetail.voucherCode || 'Kh√¥ng √°p d·ª•ng' }}</p>
                </div>
                <div class="info-row"><span>Gi·∫£m gi√°:</span>
                    <p>{{ selectedBookingForDetail.discountValue ?
                        formatCurrency(selectedBookingForDetail.discountValue) : '0 ‚Ç´' }}
                    </p>
                </div>
                <div class="info-row highlight"><span>T·ªïng thanh to√°n:</span>
                    <p>{{ formatCurrency(selectedBookingForDetail.totalPrice) }}</p>
                </div>
                <div class="info-row"><span>Xu t√≠ch l≈©y:</span>
                    <p>{{ selectedBookingForDetail.rewardPointsEarned || 0 }} ƒëi·ªÉm</p>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-primary" (click)="closeDetailModal()">ƒê√≥ng</button>
        </div>
    </div>
</div>

<!-- Modal ƒê·ªïi l·ªãch -->
<div class="modal-overlay" *ngIf="showRescheduleModal" (click)="closeRescheduleModal()"></div>
<div class="modal-container" *ngIf="showRescheduleModal" (click)="$event.stopPropagation()">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">ƒê·ªïi l·ªãch ƒë·∫∑t ph√≤ng</h5>
            <button type="button" class="btn-close" (click)="closeRescheduleModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body" *ngIf="selectedBookingForReschedule">
            <div class="info-section mb-3">
                <p><strong>Ph√≤ng:</strong> {{ selectedBookingForReschedule.room?.room_name }}</p>
                <p><strong>Th·ªùi gian hi·ªán t·∫°i:</strong> {{ selectedBookingForReschedule.startTime }} - {{
                    selectedBookingForReschedule.endTime }}</p>
                <p class="text-muted small">L∆∞u √Ω: Ch·ªâ c√≥ th·ªÉ ƒë·ªïi ng√†y v√† th·ªùi gian b·∫Øt ƒë·∫ßu. Kho·∫£ng th·ªùi gian, ph√≤ng v√†
                    d·ªãch v·ª• kh√¥ng th·ªÉ thay ƒë·ªïi.</p>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu m·ªõi <span class="text-danger">*</span></label>
                <input type="date" class="form-control" [(ngModel)]="newDate" [min]="minDate" required>
                <small class="text-muted" *ngIf="newDate">
                    <i class="bi bi-calendar3 me-1"></i>Ng√†y ƒë√£ ch·ªçn: {{ formatDateToDDMMYYYY(newDate) }}
                </small>
            </div>

            <div class="form-group mb-3">
                <label class="form-label">Gi·ªù b·∫Øt ƒë·∫ßu m·ªõi <span class="text-danger">*</span></label>
                <input type="time" class="form-control" [(ngModel)]="newStartTime" required>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeRescheduleModal()">H·ªßy</button>
            <button type="button" class="btn btn-primary" (click)="confirmReschedule()">X√°c nh·∫≠n ƒë·ªïi l·ªãch</button>
        </div>
    </div>
</div>