<div class="acc-point-wrapper container-fluid p-4">
    <div class="row justify-content-center align-items-start g-4">
        <!-- SIDEBAR -->
        <div class="col-lg-3 col-md-4 mb-4">
            <app-user-toolbar></app-user-toolbar>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-lg-9 col-md-8">
            <div class="acc-point-card shadow-lg p-4">

                <h2 class="text-center mb-4 title">L·ªãch s·ª≠ ƒë·∫∑t ph√≤ng</h2>

                <!-- ====== NAV TABS ====== -->
                <div class="order-tabs mb-3">
                    <button class="tab-btn" [class.active]="activeTab==='all'" (click)="setTab('all')">T·∫•t c·∫£</button>
                    <button class="tab-btn" [class.active]="activeTab==='pending'" (click)="setTab('pending')">Ch·ªù x√°c
                        nh·∫≠n</button>
                    <button class="tab-btn" [class.active]="activeTab==='confirmed'" (click)="setTab('confirmed')">ƒê√£
                        x√°c nh·∫≠n</button>
                    <button class="tab-btn" [class.active]="activeTab==='completed'" (click)="setTab('completed')">Ho√†n
                        th√†nh</button>
                    <button class="tab-btn" [class.active]="activeTab==='cancelled'" (click)="setTab('cancelled')">ƒê√£
                        h·ªßy</button>
                    <button class="tab-btn" [class.active]="activeTab==='no-show'" (click)="setTab('no-show')">Kh√¥ng
                        ƒë·∫øn</button>
                </div>

                <!-- ====== CARD LIST VIEW ====== -->
                <div class="order-list" *ngIf="paginatedBookings.length > 0; else emptyState">
                    <div class="order-card" *ngFor="let b of paginatedBookings" (click)="openModal(b)">
                        <div class="order-head">
                            <div class="order-id">M√£ ƒë∆°n: <strong>{{ b.id }}</strong></div>
                            <span class="badge status-badge {{ getStatusClass(b.status) }}">
                                {{ getStatusLabel(b.status) }}
                            </span>
                        </div>

                        <div class="order-body">
                            <div class="order-room">
                                <div class="room-title">{{ getRoomName(b) }}</div>
                                <div class="room-sub">{{ b.range }}</div>
                            </div>
                            <div class="order-time">
                                <div class="label">Th·ªùi gian ƒë·∫∑t ph√≤ng:</div>
                                <div class="value">{{ b.startTime }} ‚Üí {{ b.endTime }}</div>
                            </div>
                            <div class="order-price">
                                <div class="label">T·ªïng ti·ªÅn</div>
                                <div class="value">{{ formatCurrency(b.totalPrice) }}</div>
                            </div>
                            <div class="order-action">
                                <button type="button" class="btn btn-outline-primary btn-sm"
                                    (click)="$event.stopPropagation(); openModal(b)">
                                    Xem chi ti·∫øt
                                </button>
                                <button *ngIf="canPrintInvoice(b)" type="button"
                                    class="btn btn-outline-success btn-sm ms-2"
                                    (click)="$event.stopPropagation(); generateInvoice(b, $event)" title="In h√≥a ƒë∆°n">
                                    <i class="bi bi-file-earmark-pdf"></i> In h√≥a ƒë∆°n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PH√ÇN TRANG -->
                <div class="pagination-wrapper mt-4" *ngIf="totalPages > 1">
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <button class="btn btn-outline-primary btn-sm" (click)="previousPage()"
                            [disabled]="currentPage === 1">
                            <i class="bi bi-chevron-left"></i> Tr∆∞·ªõc
                        </button>

                        <div class="d-flex gap-1">
                            <button *ngFor="let page of [].constructor(totalPages); let i = index" class="btn btn-sm"
                                [class.btn-primary]="currentPage === (i + 1)"
                                [class.btn-outline-primary]="currentPage !== (i + 1)" (click)="goToPage(i + 1)">
                                {{ i + 1 }}
                            </button>
                        </div>

                        <button class="btn btn-outline-primary btn-sm" (click)="nextPage()"
                            [disabled]="currentPage === totalPages">
                            Sau <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="text-center text-muted small mt-2">
                        Trang {{ currentPage }} / {{ totalPages }} ({{ filteredBookings.length }} ƒë∆°n h√†ng)
                    </div>
                </div>

                <!-- EMPTY STATE -->
                <ng-template #emptyState>
                    <div class="order-empty text-center">
                        <div class="empty-icon">üóíÔ∏è</div>
                        <div class="empty-text">Ch∆∞a c√≥ ƒë∆°n h√†ng</div>
                    </div>
                </ng-template>
            </div>
        </div>
    </div>

    <!-- ====== MODAL POPUP ====== -->
    <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()"></div>

    <div class="modal-container" *ngIf="showModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Chi ti·∫øt ƒë·∫∑t ph√≤ng</h4>
                <button class="btn-close" (click)="closeModal()">√ó</button>
            </div>

            <div class="modal-body" *ngIf="selectedBooking">
                <!-- üîπ TH√îNG TIN KH√ÅCH H√ÄNG -->
                <div class="modal-section">
                    <h5>Th√¥ng tin kh√°ch h√†ng</h5>
                    <div class="info-row"><span>T√™n:</span>
                        <p>{{ selectedBooking.customerName }}</p>
                    </div>
                    <div class="info-row"><span>Email:</span>
                        <p>{{ selectedBooking.customerEmail }}</p>
                    </div>
                    <div class="info-row"><span>S·ªë ƒëi·ªán tho·∫°i:</span>
                        <p>{{ selectedBooking.customerPhone }}</p>
                    </div>
                </div>

                <!-- üîπ TH√îNG TIN ƒê·∫∂T PH√íNG -->
                <div class="modal-section">
                    <h5>Th√¥ng tin ƒë·∫∑t ph√≤ng</h5>
                    <div class="info-row"><span>M√£ ƒë∆°n:</span>
                        <p>{{ selectedBooking.id }}</p>
                    </div>
                    <div class="info-row"><span>Ph√≤ng:</span>
                        <p>{{ getRoomName(selectedBooking) }}</p>
                    </div>
                    <div class="info-row"><span>Ph·∫°m vi:</span>
                        <p>{{ selectedBooking.range }}</p>
                    </div>
                    <div class="info-row"><span>Gi·ªù ƒë·∫∑t:</span>
                        <p>{{ selectedBooking.startTime }} ‚Üí {{ selectedBooking.endTime }}</p>
                    </div>
                    <div class="info-row"><span>Gi·ªù s·ª≠ d·ª•ng th·ª±c t·∫ø:</span>
                        <p>
                            {{ selectedBooking.checkInTime || '‚Äî' }} ‚Üí {{ selectedBooking.checkOutTime || '‚Äî' }}
                        </p>
                    </div>
                    <div class="info-row"><span>Tr·∫°ng th√°i:</span>
                        <p><span class="badge status-badge {{ getStatusClass(selectedBooking.status) }}">
                                {{ getStatusLabel(selectedBooking.status) }}</span></p>
                    </div>
                </div>

                <!-- üîπ D·ªäCH V·ª§ ƒêI K√àM -->
                <div class="modal-section">
                    <h5>D·ªãch v·ª• ƒëi k√®m</h5>
                    <ul *ngIf="selectedBooking.services.length > 0; else noService">
                        <li *ngFor="let s of selectedBooking.services">
                            {{ s.name }}
                            <span *ngIf="s.quantity && s.quantity > 1">√ó {{ s.quantity }}</span>
                            - {{ formatCurrency(getServiceTotalPrice(s)) }}
                        </li>
                    </ul>
                    <ng-template #noService>
                        <p class="text-muted">Kh√¥ng c√≥ d·ªãch v·ª• th√™m</p>
                    </ng-template>
                </div>

                <!-- üîπ VOUCHER & THANH TO√ÅN -->
                <div class="modal-section">
                    <h5>Voucher & Thanh to√°n</h5>
                    <div class="info-row"><span>Gi√° ph√≤ng:</span>
                        <p>{{ formatCurrency(selectedBooking.basePrice || 0) }}</p>
                    </div>
                    <div class="info-row"><span>T·ªïng d·ªãch v·ª•:</span>
                        <p>{{ formatCurrency(getTotalServicesPrice(selectedBooking)) }}</p>
                    </div>
                    <div class="info-row"><span>T·∫°m t√≠nh:</span>
                        <p>{{ formatCurrency(getSubtotal(selectedBooking)) }}</p>
                    </div>
                    <div class="info-row"><span>Voucher:</span>
                        <p>{{ selectedBooking.voucherCode || 'Kh√¥ng √°p d·ª•ng' }}</p>
                    </div>
                    <div class="info-row"><span>Gi·∫£m gi√°:</span>
                        <p>{{ selectedBooking.discountValue ? formatCurrency(selectedBooking.discountValue) : '0 ‚Ç´' }}
                        </p>
                    </div>
                    <div class="info-row" *ngIf="hasUsedPoints(selectedBooking)">
                        <span>ƒê·ªïi Xu:</span>
                        <p>ƒê√£ d√πng 50 Xu - Gi·∫£m {{ formatCurrency(getPointsDiscountValue(selectedBooking)) }}</p>
                    </div>
                    <div class="info-row highlight"><span>T·ªïng thanh to√°n:</span>
                        <p>{{ formatCurrency(selectedBooking.totalPrice) }}</p>
                    </div>
                    <div class="info-row"><span>Xu t√≠ch l≈©y:</span>
                        <p>{{ selectedBooking.rewardPointsEarned || 0 }} ƒëi·ªÉm</p>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button *ngIf="selectedBooking && canPrintInvoice(selectedBooking)" class="btn btn-success me-2"
                    (click)="generateInvoice(selectedBooking)">
                    <i class="bi bi-file-earmark-pdf"></i> In h√≥a ƒë∆°n
                </button>
                <button class="btn btn-primary" (click)="closeModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>